daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
daily_consumption[,residuals := residuals(reg1)]
library(data.table)
library(lubridate)
library(zoo)
library(forecast)
library(mgcv)
library(urca)
library(ggplot2)
library(gratia)
consumption<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-01012017-08012021.csv")
consumption[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption[,Consumption:=gsub('\\,','\\',Consumption)]
consumption[,Consumption:=as.numeric(Consumption)]
head(consumption,25)
daily_consumption<-consumption[,list(mean_consumption=mean(Consumption,na.rm=T)),by=list(Date)]
ggplot(daily_consumption,aes(x=Date))+ geom_line(aes(y=mean_consumption))
daily_consumption[,differ:=mean_consumption-shift(mean_consumption,7)]
ggplot(daily_consumption,aes(x=Date)) + geom_line(aes(y=differ))
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
unt_test=ur.kpss(daily_consumption$mean_consumption)
summary(unt_test)
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
acf(daily_consumption$mean_consumption)
pacf(daily_consumption$mean_consumption)
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid,daily_consumption$outlier1)
fitted1<-auto.arima(daily_consumption$differ,xreg=reg1,seasonal=F,trace=T)
forecast_dates<-c("2021-01-09","2021-01-10","2021-01-11","2021-01-12","2021-01-13","2021-01-14","2021-01-15","2021-01-16","2021-01-17","2021-01-18","2021-01-19","2021-01-20","2021-01-21","2021-01-22")
daily_consumption<-rbind(daily_consumption,data.table(Date=as.Date(forecast_dates)),fill=T)
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
reg<-lm(differ~yeni_yil1+on_dokuz_mayis1+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid+,daily_consumption)
library(data.table)
library(lubridate)
library(zoo)
library(forecast)
library(mgcv)
library(urca)
library(ggplot2)
library(gratia)
consumption<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-01012017-08012021.csv")
consumption[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption[,Consumption:=gsub('\\,','\\',Consumption)]
consumption[,Consumption:=as.numeric(Consumption)]
head(consumption,25)
daily_consumption<-consumption[,list(mean_consumption=mean(Consumption,na.rm=T)),by=list(Date)]
ggplot(daily_consumption,aes(x=Date))+ geom_line(aes(y=mean_consumption))
daily_consumption[,differ:=mean_consumption-shift(mean_consumption,7)]
ggplot(daily_consumption,aes(x=Date)) + geom_line(aes(y=differ))
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
unt_test=ur.kpss(daily_consumption$mean_consumption)
summary(unt_test)
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
acf(daily_consumption$mean_consumption)
pacf(daily_consumption$mean_consumption)
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid,daily_consumption$outlier1)
fitted1<-auto.arima(daily_consumption$differ,xreg=reg1,seasonal=F,trace=T)
forecast_dates<-c("2021-01-09","2021-01-10","2021-01-11","2021-01-12","2021-01-13","2021-01-14","2021-01-15","2021-01-16","2021-01-17","2021-01-18","2021-01-19","2021-01-20","2021-01-21","2021-01-22")
daily_consumption<-rbind(daily_consumption,data.table(Date=as.Date(forecast_dates)),fill=T)
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
reg<-lm(differ~yeni_yil1+on_dokuz_mayis1+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
daily_consumption[,residuals := residuals(reg)]
library(data.table)
library(lubridate)
library(zoo)
library(forecast)
library(mgcv)
library(urca)
library(ggplot2)
library(gratia)
consumption<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-01012017-08012021.csv")
consumption[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption[,Consumption:=gsub('\\,','\\',Consumption)]
consumption[,Consumption:=as.numeric(Consumption)]
head(consumption,25)
daily_consumption<-consumption[,list(mean_consumption=mean(Consumption,na.rm=T)),by=list(Date)]
ggplot(daily_consumption,aes(x=Date))+ geom_line(aes(y=mean_consumption))
daily_consumption[,differ:=mean_consumption-shift(mean_consumption,7)]
ggplot(daily_consumption,aes(x=Date)) + geom_line(aes(y=differ))
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
unt_test=ur.kpss(daily_consumption$mean_consumption)
summary(unt_test)
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
acf(daily_consumption$mean_consumption)
pacf(daily_consumption$mean_consumption)
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
fitted1<-auto.arima(daily_consumption$differ,xreg=reg1,seasonal=F,trace=T)
forecast_dates<-c("2021-01-09","2021-01-10","2021-01-11","2021-01-12","2021-01-13","2021-01-14","2021-01-15","2021-01-16","2021-01-17","2021-01-18","2021-01-19","2021-01-20","2021-01-21","2021-01-22")
daily_consumption<-rbind(daily_consumption,data.table(Date=as.Date(forecast_dates)),fill=T)
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
reg<-lm(differ~yeni_yil1+on_dokuz_mayis1+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg<-lm(differ~yeni_yil+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
unt_test=ur.kpss(daily_consumption$differ)
summary(unt_test)
forecasted<-forecast(fitted1,h=14,xreg=tail(reg1,14))
forecasted$mean
daily_consumption[,forecast_differ:=c(rep(NA,7),fitted1$fitted,forecasted$mean)]
daily_consumption[Date<="2021-01-15",f1:=forecast_differ+shift(mean_consumption,7)]
daily_consumption[Date>"2021-01-15",f1:=forecast_differ+tail(daily_consumption[is.na(mean_consumption)==F,mean_consumption],7)]
daily_consumption[Date<="2021-01-15",f2:=forecast_differ+shift(mean_consumption,7)]
daily_consumption[Date>"2021-01-15",f2:=tail(daily_consumption$forecast_differ,7)+daily_consumption[Date%between%as.Date(c("2021-01-09","2021-01-15")),f2]]
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
tail(daily_consumption,30)
consumption1<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-09012021-22012021.csv")
consumption1[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption1[,Consumption:=gsub('\\,','\\',Consumption)]
consumption1[,Consumption:=as.numeric(Consumption)]
consumption1
daily_consumption1<-consumption1[,list(mean_consumption1=mean(Consumption,na.rm=T)),by=list(Date)]
daily_consumption1
accu = function(actual, forecast){
n = length(actual)
error = actual - forecast
mean = mean(actual)
sd = sd(actual)
FBias = sum(error)/sum(actual)
MPE = sum(error/actual)/n
MAPE = sum(abs(error/actual))/n
RMSE = sqrt(sum(error^2)/n)
MAD = sum(abs(error))/n
WMAPE = MAD/mean
return(data.frame(n,sd,FBias,MPE,MAPE,RMSE,MAD,WMAPE))
}
accu(daily_consumption1$mean_consumption1,tail(daily_consumption$f2,14))
library(data.table)
library(lubridate)
library(zoo)
library(forecast)
library(mgcv)
library(urca)
library(ggplot2)
library(gratia)
consumption<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-01012017-08012021.csv")
consumption[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption[,Consumption:=gsub('\\,','\\',Consumption)]
consumption[,Consumption:=as.numeric(Consumption)]
head(consumption,25)
daily_consumption<-consumption[,list(mean_consumption=mean(Consumption,na.rm=T)),by=list(Date)]
ggplot(daily_consumption,aes(x=Date))+ geom_line(aes(y=mean_consumption))
daily_consumption[,differ:=mean_consumption-shift(mean_consumption,7)]
ggplot(daily_consumption,aes(x=Date)) + geom_line(aes(y=differ))
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
unt_test=ur.kpss(daily_consumption$mean_consumption)
summary(unt_test)
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
acf(daily_consumption$mean_consumption)
pacf(daily_consumption$mean_consumption)
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
fitted1<-auto.arima(daily_consumption$differ,xreg=reg1,seasonal=F,trace=T)
forecast_dates<-c("2021-01-09","2021-01-10","2021-01-11","2021-01-12","2021-01-13","2021-01-14","2021-01-15","2021-01-16","2021-01-17","2021-01-18","2021-01-19","2021-01-20","2021-01-21","2021-01-22")
daily_consumption<-rbind(daily_consumption,data.table(Date=as.Date(forecast_dates)),fill=T)
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-04-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
reg<-lm(differ~yeni_yil1+on_dokuz_mayis1+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg<-lm(differ~yeni_yil+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
unt_test=ur.kpss(daily_consumption$differ)
summary(unt_test)
forecasted<-forecast(fitted1,h=14,xreg=tail(reg1,14))
forecasted$mean
daily_consumption[,forecast_differ:=c(rep(NA,7),fitted1$fitted,forecasted$mean)]
daily_consumption[Date<="2021-01-15",f2:=forecast_differ+shift(mean_consumption,7)]
daily_consumption[Date>"2021-01-15",f2:=tail(daily_consumption$forecast_differ,7)+daily_consumption[Date%between%as.Date(c("2021-01-09","2021-01-15")),f2]]
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
tail(daily_consumption,30)
consumption1<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-09012021-22012021.csv")
consumption1[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption1[,Consumption:=gsub('\\,','\\',Consumption)]
consumption1[,Consumption:=as.numeric(Consumption)]
consumption1
daily_consumption1<-consumption1[,list(mean_consumption1=mean(Consumption,na.rm=T)),by=list(Date)]
daily_consumption1
accu = function(actual, forecast){
n = length(actual)
error = actual - forecast
mean = mean(actual)
sd = sd(actual)
FBias = sum(error)/sum(actual)
MPE = sum(error/actual)/n
MAPE = sum(abs(error/actual))/n
RMSE = sqrt(sum(error^2)/n)
MAD = sum(abs(error))/n
WMAPE = MAD/mean
return(data.frame(n,sd,FBias,MPE,MAPE,RMSE,MAD,WMAPE))
}
accu(daily_consumption1$mean_consumption1,tail(daily_consumption$f2,14))
library(data.table)
library(lubridate)
library(zoo)
library(forecast)
library(mgcv)
library(urca)
library(ggplot2)
library(gratia)
consumption<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-01012017-08012021.csv")
consumption[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption[,Consumption:=gsub('\\,','\\',Consumption)]
consumption[,Consumption:=as.numeric(Consumption)]
head(consumption,25)
daily_consumption<-consumption[,list(mean_consumption=mean(Consumption,na.rm=T)),by=list(Date)]
ggplot(daily_consumption,aes(x=Date))+ geom_line(aes(y=mean_consumption))
daily_consumption[,differ:=mean_consumption-shift(mean_consumption,7)]
ggplot(daily_consumption,aes(x=Date)) + geom_line(aes(y=differ))
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
unt_test=ur.kpss(daily_consumption$mean_consumption)
summary(unt_test)
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-05-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
acf(daily_consumption$mean_consumption)
pacf(daily_consumption$mean_consumption)
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
fitted1<-auto.arima(daily_consumption$differ,xreg=reg1,seasonal=F,trace=T)
forecast_dates<-c("2021-01-09","2021-01-10","2021-01-11","2021-01-12","2021-01-13","2021-01-14","2021-01-15","2021-01-16","2021-01-17","2021-01-18","2021-01-19","2021-01-20","2021-01-21","2021-01-22")
daily_consumption<-rbind(daily_consumption,data.table(Date=as.Date(forecast_dates)),fill=T)
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
daily_consumption[,yeni_yil:=0]
daily_consumption[Date %in% as.Date(c("2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01")),yeni_yil:=1]
daily_consumption[,yeni_yil1:=yeni_yil-shift(yeni_yil,7)]
daily_consumption[,yirmi_uc_nisan:=0]
daily_consumption[Date %in% as.Date(c("2017-04-23","2018-04-23","2019-04-23","2020-04-23")),yirmi_uc_nisan:=1]
daily_consumption[,yirmi_uc_nisan1:=yirmi_uc_nisan-shift(yirmi_uc_nisan,7)]
daily_consumption[,on_dokuz_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-05-19","2018-05-19","2019-05-19","2020-05-19")),on_dokuz_mayis:=1]
daily_consumption[,on_dokuz_mayis1:=on_dokuz_mayis-shift(on_dokuz_mayis,7)]
daily_consumption[,bir_mayis:=0]
daily_consumption[Date %in% as.Date(c("2017-04-30","2017-05-01","2018-05-01","2019-05-01","2020-05-01")),bir_mayis:=1]
daily_consumption[,bir_mayis1:=bir_mayis-shift(bir_mayis,7)]
daily_consumption[,on_bes_temmuz:=0]
daily_consumption[Date %in% as.Date(c("2018-07-15","2019-07-15")),on_bes_temmuz:=1]
daily_consumption[,on_bes_temmuz1:=on_bes_temmuz-shift(on_bes_temmuz,7)]
daily_consumption[,yirmi_dokuz_ekim:=0]
daily_consumption[Date %in% as.Date(c("2017-10-29","2018-10-28","2018-10-29","2019-10-27","2019-10-28","2019-10-29")),yirmi_dokuz_ekim:=1]
daily_consumption[,yirmi_dokuz_ekim1:=yirmi_dokuz_ekim-shift(yirmi_dokuz_ekim,7)]
daily_consumption[,ramazan_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-06-24","2017-06-25","2017-06-26","2017-06-27","2018-06-14","2018-06-15","2018-06-16","2018-06-17","2019-06-02","2019-06-03","2019-06-04","2019-06-05","2019-06-06","2019-06-07","2019-06-08","2019-06-09","2020-05-23","2020-05-24","2020-05-25","2020-05-26")),ramazan_bayrami:=1]
daily_consumption[,ramazan_bayrami1:=ramazan_bayrami-shift(ramazan_bayrami,7)]
daily_consumption[,kurban_bayrami:=0]
daily_consumption[Date %in% as.Date(c("2017-08-31","2017-09-01","2017-09-02","2017-09-03","2017-09-04","2018-08-20","2018-08-21","2018-08-22","2018-08-23","2018-08-24","2019-08-11","2019-08-12","2019-08-13","2019-08-14","2020-07-31","2020-08-01","2020-08-02","2020-08-03")),kurban_bayrami:=1]
daily_consumption[,kurban_bayrami1:=kurban_bayrami-shift(kurban_bayrami,7)]
daily_consumption[,covid19:=0]
daily_consumption[Date>="2020-05-01" & Date<="2020-07-01" ,covid19:=1]
daily_consumption[,covid:=covid19-shift(covid19,7)]
reg<-lm(differ~yeni_yil1+on_dokuz_mayis1+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg<-lm(differ~yeni_yil+yirmi_uc_nisan1+bir_mayis1+on_bes_temmuz1+yirmi_dokuz_ekim1+ramazan_bayrami1+kurban_bayrami1+covid,daily_consumption)
summary(reg)
plot(reg$residual,main="Residuals daily")
reg1<-cbind(as.factor(daily_consumption$w_day),as.factor(daily_consumption$mon),as.factor(daily_consumption$y_day),daily_consumption$time_index,daily_consumption$yeni_yil1,daily_consumption$yirmi_uc_nisan1,daily_consumption$bir_mayis1,daily_consumption$on_bes_temmuz1,daily_consumption$yirmi_dokuz_ekim1,daily_consumption$ramazan_bayrami1,daily_consumption$kurban_bayrami1,daily_consumption$covid)
unt_test=ur.kpss(daily_consumption$differ)
summary(unt_test)
forecasted<-forecast(fitted1,h=14,xreg=tail(reg1,14))
forecasted$mean
daily_consumption[,forecast_differ:=c(rep(NA,7),fitted1$fitted,forecasted$mean)]
daily_consumption[Date<="2021-01-15",f2:=forecast_differ+shift(mean_consumption,7)]
daily_consumption[Date>"2021-01-15",f2:=tail(daily_consumption$forecast_differ,7)+daily_consumption[Date%between%as.Date(c("2021-01-09","2021-01-15")),f2]]
daily_consumption[,w_day:=weekdays(Date)]
daily_consumption[,y_day:=yday(Date)]
daily_consumption[,mon:=months(Date)]
daily_consumption[,time_index:=1:.N]
tail(daily_consumption,30)
consumption1<-fread("D:/Boğaziçi/İe360/data/hw4/RealTimeConsumption-09012021-22012021.csv")
consumption1[,Date:=as.Date(Date,format = "%d.%m.%Y")]
consumption1[,Consumption:=gsub('\\,','\\',Consumption)]
consumption1[,Consumption:=as.numeric(Consumption)]
consumption1
daily_consumption1<-consumption1[,list(mean_consumption1=mean(Consumption,na.rm=T)),by=list(Date)]
daily_consumption1
accu = function(actual, forecast){
n = length(actual)
error = actual - forecast
mean = mean(actual)
sd = sd(actual)
FBias = sum(error)/sum(actual)
MPE = sum(error/actual)/n
MAPE = sum(abs(error/actual))/n
RMSE = sqrt(sum(error^2)/n)
MAD = sum(abs(error))/n
WMAPE = MAD/mean
return(data.frame(n,sd,FBias,MPE,MAPE,RMSE,MAD,WMAPE))
}
accu(daily_consumption1$mean_consumption1,tail(daily_consumption$f2,14))
